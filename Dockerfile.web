# ---------- deps: install node modules ----------
FROM node:20-alpine AS deps
WORKDIR /app
ENV NEXT_TELEMETRY_DISABLED=1
# Needed for building native deps like sharp
RUN apk add --no-cache libc6-compat python3 make g++
COPY web/package.json web/package-lock.json ./
# Use npm ci with increased memory and timeout for Railway
RUN npm ci --maxsockets 1 --prefer-offline

# ---------- build: compile Next.js (standalone) ----------
FROM node:20-alpine AS build
WORKDIR /app
ENV NEXT_TELEMETRY_DISABLED=1
# Increase Node.js memory limit for Railway builds
ENV NODE_OPTIONS="--max-old-space-size=2048"
# Public build args (baked into the bundle)
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
ENV NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY=${NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY}
# Node modules from deps stage
COPY --from=deps /app/node_modules ./node_modules
# App source
COPY web ./
# Copy the docs directory so the prebuild script can find api-contracts.yaml
COPY docs /docs
# Optional: quick visibility during build
RUN echo "Building with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"
# Verify API contracts file exists before build
RUN ls -la /docs/api-contracts.yaml || echo "Warning: API contracts file not found"
# Build with error handling and verbose output for debugging
RUN npm run build || (echo "Build failed, checking logs..." && cat .next/trace || exit 1)

# ---------- runner: minimal production image ----------
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
# Runtime-only vars (e.g., server-side fetches from the web container to backend)
ARG API_URL
ENV API_URL=${API_URL}
# Expose public vars at runtime too (handy for diagnostics or edge cases)
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
ENV NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY=${NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY}
# Runtime deps for sharp
RUN apk add --no-cache libc6-compat
# Copy Next standalone output
COPY --from=build /app/.next/standalone ./
COPY --from=build /app/.next/static ./.next/static
COPY --from=build /app/public ./public
# Keep package.json around (some setups expect it at runtime)
COPY web/package.json ./package.json
ENV PORT=3000
EXPOSE 3000
# Create non-root user for security
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs
CMD ["node", "server.js"]