name: Validate Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of validation to run'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - railway
          - aws
          - all

jobs:
  validate-secrets:
    name: Validate Repository Secrets
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      BACKUP_S3_BUCKET: ${{ secrets.BACKUP_S3_BUCKET }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    steps:
      - name: Check Basic Secrets
        if: github.event.inputs.check_type == 'basic' || github.event.inputs.check_type == 'all'
        run: |
          echo "## 🔍 Basic Secrets Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Railway secrets (without exposing values)
          if [ -n "$RAILWAY_TOKEN" ]; then
            echo "✅ RAILWAY_TOKEN: Available (length: ${#RAILWAY_TOKEN})" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ RAILWAY_TOKEN: Missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            echo "✅ RAILWAY_PROJECT_ID: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ RAILWAY_PROJECT_ID: Missing" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Railway Connection
        if: github.event.inputs.check_type == 'railway' || github.event.inputs.check_type == 'all'
        run: |
          echo "## 🚂 Railway Connection Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "❌ Cannot test Railway - RAILWAY_TOKEN missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Install Railway CLI
          npm install -g @railway/cli
          
          # Test authentication
          if railway whoami > /dev/null 2>&1; then
            echo "✅ Railway authentication successful" >> $GITHUB_STEP_SUMMARY
            
            # Test project linking
            if [ -n "$RAILWAY_PROJECT_ID" ]; then
              if railway link "$RAILWAY_PROJECT_ID" > /dev/null 2>&1; then
                echo "✅ Railway project linking successful" >> $GITHUB_STEP_SUMMARY
                
                # List services
                echo "### Available Services:" >> $GITHUB_STEP_SUMMARY
                railway status --json | jq -r '.services[].name' | while read service; do
                  echo "- $service" >> $GITHUB_STEP_SUMMARY
                done
              else
                echo "❌ Railway project linking failed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "⚠️ RAILWAY_PROJECT_ID not set - cannot test project linking" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Railway authentication failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check AWS Secrets
        if: github.event.inputs.check_type == 'aws' || github.event.inputs.check_type == 'all'
        run: |
          echo "## ☁️ AWS Secrets Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check AWS secrets
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then
            echo "✅ AWS_ACCESS_KEY_ID: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ AWS_ACCESS_KEY_ID: Missing (optional for S3 backups)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "✅ AWS_SECRET_ACCESS_KEY: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ AWS_SECRET_ACCESS_KEY: Missing (optional for S3 backups)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$AWS_REGION" ]; then
            echo "✅ AWS_REGION: Available ($AWS_REGION)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ AWS_REGION: Missing (optional for S3 backups)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$BACKUP_S3_BUCKET" ]; then
            echo "✅ BACKUP_S3_BUCKET: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ BACKUP_S3_BUCKET: Missing (optional for S3 backups)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Notification Secrets
        if: github.event.inputs.check_type == 'all'
        run: |
          echo "## 📢 Notification Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "✅ SLACK_WEBHOOK_URL: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ SLACK_WEBHOOK_URL: Missing (optional for notifications)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Recommendations
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 💡 Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if critical secrets are missing
          MISSING_CRITICAL=false
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "🔴 **CRITICAL**: Add RAILWAY_TOKEN to repository secrets" >> $GITHUB_STEP_SUMMARY
            MISSING_CRITICAL=true
          fi
          
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "🔴 **CRITICAL**: Add RAILWAY_PROJECT_ID to repository secrets" >> $GITHUB_STEP_SUMMARY
            MISSING_CRITICAL=true
          fi
          
          if [ "$MISSING_CRITICAL" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### How to fix:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to repository Settings → Secrets and variables → Actions" >> $GITHUB_STEP_SUMMARY
            echo "2. Add the missing secrets with correct values" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run this workflow to validate" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All critical secrets are configured!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optional improvements:" >> $GITHUB_STEP_SUMMARY
          echo "- Configure AWS secrets for S3 backup storage" >> $GITHUB_STEP_SUMMARY
          echo "- Add Slack webhook for deployment notifications" >> $GITHUB_STEP_SUMMARY
