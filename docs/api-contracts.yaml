openapi: 3.0.3
info:
  title: MDV API (MVP)
  version: "0.1.0"
servers:
  - url: http://localhost:8000
paths:
  /health:
    get:
      summary: Health check
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /api/products:
    get:
      summary: List products
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sort
          schema: { type: string, enum: [relevance, newest, price_asc, price_desc], default: relevance }
      responses:
        200:
          description: Products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedProducts'
  /api/products/{idOrSlug}:
    get:
      summary: Get product
      parameters:
        - in: path
          name: idOrSlug
          required: true
          schema: { type: string }
      responses:
        200:
          description: Product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        404: { description: Not found }
  /api/cart:
    post:
      summary: Create cart
      responses:
        200:
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartCreateResponse'
  /api/cart/{cart_id}:
    get:
      summary: Get cart
      parameters:
        - in: path
          name: cart_id
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        404: { description: Not found }
  /api/cart/{cart_id}/items:
    post:
      summary: Add item to cart
      parameters:
        - in: path
          name: cart_id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartItemIn'
      responses:
        200:
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
  /api/cart/{cart_id}/items/{item_id}:
    put:
      summary: Update item quantity
      parameters:
        - in: path
          name: cart_id
          required: true
          schema: { type: integer }
        - in: path
          name: item_id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartItemQtyUpdate'
      responses:
        200:
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
    delete:
      summary: Remove item from cart
      parameters:
        - in: path
          name: cart_id
          required: true
          schema: { type: integer }
        - in: path
          name: item_id
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
  /api/cart/{cart_id}/clear:
    post:
      summary: Clear cart
      parameters:
        - in: path
          name: cart_id
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Emptied cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
  /api/shipping/calculate:
    get:
      summary: Shipping preview
      parameters:
        - in: query
          name: state
          required: true
          schema: { type: string }
        - in: query
          name: subtotal
          required: false
          schema: { type: number }
        - in: query
          name: coupon_code
          required: false
          schema: { type: string }
      responses:
        200:
          description: Estimate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShippingEstimate'
  /api/checkout/init:
    post:
      summary: Initialize checkout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutInitRequest'
      responses:
        200:
          description: Authorization URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutInitResponse'
  /api/orders/{order_id}/tracking:
    get:
      summary: Get order tracking status
      parameters:
        - in: path
          name: order_id
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Tracking
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderTrackingResponse'
        404: { description: Not found }
  /api/paystack/webhook:
    post:
      summary: Paystack webhook
      parameters:
        - in: header
          name: x-paystack-signature
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        200: { description: OK }
  /api/paystack/mock:
    post:
      summary: Local mock to simulate Paystack events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event: { type: string }
                data:
                  type: object
                  properties:
                    reference: { type: string }
      responses:
        200: { description: OK }
  /api/paystack/verify:
    get:
      summary: Verify payment by reference
      parameters:
        - in: query
          name: reference
          required: true
          schema: { type: string }
      responses:
        200: { description: OK }
  /api/auth/login:
    post:
      summary: Staff login (MVP)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
      responses:
        200:
          description: Token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthLoginResponse'
  /api/admin/reports/categories:
    get:
      summary: Admin categories report
      description: Aggregated category-level inventory and sales metrics.
      parameters:
        - in: query
          name: period
          schema:
            type: string
            enum: ["7d", "30d", "90d", "365d"]
          description: Time window for sales metrics
      responses:
        200:
          description: Categories report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoriesReportResponse'

  /api/admin/reports/export/categories:
    get:
      summary: Export categories report as CSV
      description: Returns a JSON string that contains the CSV text for the categories report.
      parameters:
        - in: query
          name: period
          schema:
            type: string
            enum: ["7d", "30d", "90d", "365d"]
          description: Time window for sales metrics
      responses:
        200:
          description: CSV content as JSON string
          content:
            application/json:
              schema:
                type: string

  /api/admin/logistics/stats:
    get:
      summary: Get logistics dashboard statistics
      description: Returns comprehensive statistics for the logistics dashboard including shipment counts by status and tab-specific counts.
      security:
        - bearerAuth: []
      responses:
        200:
          description: Logistics statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsStatsResponse'

  /api/admin/logistics/all-orders:
    get:
      summary: Get all orders in logistics pipeline
      description: Returns all paid orders that have fulfillments (in logistics pipeline) with comprehensive status information.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        200:
          description: Orders in logistics pipeline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsOrdersResponse'

  /api/admin/logistics/ready-to-ship:
    get:
      summary: Get orders ready to ship
      description: Returns orders that are ready to ship (fulfillment ready but no shipment created).
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        200:
          description: Orders ready to ship
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsOrdersResponse'

  /api/admin/logistics/in-transit:
    get:
      summary: Get orders in transit
      description: Returns orders that are currently being shipped (dispatched or in_transit status).
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        200:
          description: Orders in transit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsOrdersResponse'

  /api/admin/logistics/delivered:
    get:
      summary: Get delivered orders
      description: Returns orders that have been successfully delivered.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        200:
          description: Delivered orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsOrdersResponse'

  /api/admin/logistics/pending-dispatch:
    get:
      summary: Get orders pending dispatch
      description: Returns orders that are ready to ship but awaiting shipment creation.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        200:
          description: Orders pending dispatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogisticsOrdersResponse'

  /api/admin/logistics/bulk-create-shipments:
    post:
      summary: Create shipments for multiple orders in bulk
      description: Creates shipments for multiple orders simultaneously. Supports up to 100 orders per request.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkCreateShipmentsRequest'
      responses:
        200:
          description: Bulk shipment creation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkActionResponse'

  /api/admin/logistics/bulk-update-status:
    post:
      summary: Update shipment status for multiple orders in bulk
      description: Updates shipment status for multiple orders simultaneously. Supports up to 100 orders per request.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkUpdateStatusRequest'
      responses:
        200:
          description: Bulk status update results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkActionResponse'

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status: { type: string }
        service: { type: string }
        version: { type: string }
    PaginatedProducts:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        total: { type: integer }
        page: { type: integer }
        page_size: { type: integer }
    Variant:
      type: object
      properties:
        id: { type: integer }
        sku: { type: string }
        size: { type: string, nullable: true }
        color: { type: string, nullable: true }
        price: { type: number }
    Product:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        slug: { type: string }
        description: { type: string, nullable: true }
        compare_at_price: { type: number, nullable: true }
        variants:
          type: array
          items:
            $ref: '#/components/schemas/Variant'
        images:
          type: array
          items:
            $ref: '#/components/schemas/ProductImage'
    CartCreateResponse:
      type: object
      properties:
        id: { type: integer }
    CartItem:
      type: object
      properties:
        id: { type: integer }
        variant_id: { type: integer }
        qty: { type: integer }
        title: { type: string, nullable: true }
        price: { type: number, nullable: true }
        image_url: { type: string, nullable: true }
    CartItemIn:
      type: object
      required: [variant_id, qty]
      properties:
        variant_id: { type: integer }
        qty: { type: integer, minimum: 1 }
    CartItemQtyUpdate:
      type: object
      required: [qty]
      properties:
        qty: { type: integer, minimum: 1 }
    Cart:
      type: object
      properties:
        id: { type: integer }
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
    ShippingEstimate:
      type: object
      properties:
        shipping_fee: { type: number }
        free_shipping_eligible: { type: boolean }
        reason: { type: string, nullable: true }
    AddressIn:
      type: object
      properties:
        name: { type: string }
        phone: { type: string }
        state: { type: string }
        city: { type: string }
        street: { type: string }
    CheckoutInitRequest:
      type: object
      properties:
        cart_id: { type: integer }
        address: { $ref: '#/components/schemas/AddressIn' }
        email: { type: string, format: email }
        coupon_code: { type: string, nullable: true }
    CheckoutInitResponse:
      type: object
      properties:
        order_id: { type: integer }
        authorization_url: { type: string, format: uri }
        reference: { type: string }
        totals:
          type: object
          additionalProperties: true
    AuthLoginRequest:
      type: object
      properties:
        email: { type: string, format: email }
        password: { type: string }
    AuthLoginResponse:
      type: object
      properties:
        access_token: { type: string, nullable: true }
        token: { type: string, nullable: true }
        token_type: { type: string }
        role: { type: string }
        force_password_change: { type: boolean, nullable: true }
        user_id: { type: integer, nullable: true }
        message: { type: string, nullable: true }
    ProductImage:
      type: object
      properties:
        id: { type: integer }
        url: { type: string }
        alt_text: { type: string, nullable: true }
        width: { type: integer, nullable: true }
        height: { type: integer, nullable: true }
        sort_order: { type: integer }
        is_primary: { type: boolean }
    OrderTrackingResponse:
      type: object
      properties:
        order_id: { type: integer }
        status: { type: string }
        timeline:
          type: array
          items:
            type: object
            properties:
              code: { type: string }
              at: { type: string, format: date-time }
              message: { type: string, nullable: true }
    CategoriesReportCategory:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        product_count: { type: integer }
        variant_count: { type: integer }
        total_inventory_qty: { type: integer }
        inventory_value: { type: number }
        low_stock_count: { type: integer }
        sales_revenue: { type: number }
        orders_count: { type: integer }
    CategoriesReportSummary:
      type: object
      properties:
        product_count: { type: integer }
        variant_count: { type: integer }
        total_inventory_qty: { type: integer }
        inventory_value: { type: number }
        low_stock_count: { type: integer }
        sales_revenue: { type: number }
        orders_count: { type: integer }
    CategoriesReportResponse:
      type: object
      properties:
        period: { type: string }
        total_categories: { type: integer }
        summary: { $ref: '#/components/schemas/CategoriesReportSummary' }
        categories:
          type: array
          items: { $ref: '#/components/schemas/CategoriesReportCategory' }

    LogisticsStatsResponse:
      type: object
      properties:
        total_shipments: { type: integer }
        dispatched: { type: integer }
        in_transit: { type: integer }
        delivered: { type: integer }
        returned: { type: integer }
        pending_dispatch: { type: integer }
        ready_to_ship: { type: integer }
        all_orders: { type: integer }
        in_transit_total: { type: integer }
        tabs:
          type: object
          properties:
            all_orders: { type: integer }
            ready_to_ship: { type: integer }
            in_transit: { type: integer }
            delivered: { type: integer }
            pending_dispatch: { type: integer }

    LogisticsOrdersResponse:
      type: object
      properties:
        orders:
          type: array
          items: { $ref: '#/components/schemas/LogisticsOrder' }

    LogisticsOrder:
      type: object
      properties:
        id: { type: integer }
        order_number: { type: string }
        customer_name: { type: string }
        items_count: { type: integer }
        total_amount: { type: number }
        created_at: { type: string, format: date-time }
        logistics_status: { type: string }
        fulfillment_status: { type: string }
        shipment_status: { type: string }
        tracking_id: { type: string }
        courier: { type: string }
        dispatched_at: { type: string, format: date-time }
        delivered_at: { type: string, format: date-time }
        packed_at: { type: string, format: date-time }
        pending_hours: { type: number }
        fulfillment_notes: { type: string }
        shipping_address:
          type: object
          properties:
            city: { type: string }
            state: { type: string }
            street: { type: string }

    BulkCreateShipmentsRequest:
      type: object
      required:
        - order_ids
      properties:
        order_ids:
          type: array
          items: { type: integer }
          maxItems: 100
          description: Array of order IDs to create shipments for (max 100)
        courier:
          type: string
          default: "DHL"
          description: Courier service for the shipments

    BulkUpdateStatusRequest:
      type: object
      required:
        - order_ids
        - status
      properties:
        order_ids:
          type: array
          items: { type: integer }
          maxItems: 100
          description: Array of order IDs to update (max 100)
        status:
          type: string
          enum: ["dispatched", "in_transit", "delivered", "returned"]
          description: New shipment status
        notes:
          type: string
          description: Optional notes for the status update

    BulkActionResponse:
      type: object
      properties:
        message: { type: string }
        results:
          type: object
          properties:
            total_processed: { type: integer }
            success:
              type: array
              items:
                type: object
                properties:
                  order_id: { type: integer }
                  tracking_id: { type: string }
                  old_status: { type: string }
                  new_status: { type: string }
            failed:
              type: array
              items:
                type: object
                properties:
                  order_id: { type: integer }
                  error: { type: string }
